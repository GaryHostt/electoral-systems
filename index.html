<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electoral Systems Simulator</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="comparison.css">
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>ğŸ—³ï¸ Electoral Systems Simulator</h1>
            <p class="subtitle">Compare different voting systems and understand their implications</p>
            <div style="margin-top: 15px;">
                <a href="learn-more.html" class="learn-more-btn" target="_blank">
                    ğŸ“š Learn More About Electoral Systems
                </a>
            </div>
        </header>

        <div class="main-content">
            <!-- Historical Election Presets - Collapsible -->
            <section class="card" id="presetsSection" style="display: none;">
                <button onclick="togglePresetsPanel()" class="country-toggle-btn">
                    <span id="presetsToggleIcon">â–¶</span> ğŸ“œ Simulate Past Election
                </button>
                
                <div id="presetsPanel" class="country-import-panel" style="display: none;">
                    <p style="margin-bottom: 15px; color: #666;">Load real-world election data to see actual results or run counterfactual analyses by switching electoral systems:</p>
                    
                    <div class="country-grid">
                        <!-- Germany (newest first) -->
                        <button onclick="importElectionPreset('germany_2021')" class="country-btn">
                            <span class="country-flag">ğŸ‡©ğŸ‡ª</span>
                            <span class="country-name">Germany 2021</span>
                            <span class="country-count">MMP â€¢ 598 seats â€¢ 5% threshold â€¢ Sainte-LaguÃ«</span>
                        </button>
                        <button onclick="importElectionPreset('germany_2017')" class="country-btn">
                            <span class="country-flag">ğŸ‡©ğŸ‡ª</span>
                            <span class="country-name">Germany 2017</span>
                            <span class="country-count">MMP â€¢ 598 seats â€¢ 5% threshold â€¢ Sainte-LaguÃ«</span>
                        </button>
                        <button onclick="importElectionPreset('germany_2013')" class="country-btn">
                            <span class="country-flag">ğŸ‡©ğŸ‡ª</span>
                            <span class="country-name">Germany 2013</span>
                            <span class="country-count">MMP â€¢ 598 seats â€¢ 5% threshold â€¢ Sainte-LaguÃ«</span>
                        </button>
                        
                        <!-- Japan (newest first) -->
                        <button onclick="importElectionPreset('japan_2024')" class="country-btn">
                            <span class="country-flag">ğŸ‡¯ğŸ‡µ</span>
                            <span class="country-name">Japan 2024</span>
                            <span class="country-count">Parallel â€¢ 465 seats â€¢ No threshold â€¢ D'Hondt</span>
                        </button>
                        <button onclick="importElectionPreset('japan_2021')" class="country-btn">
                            <span class="country-flag">ğŸ‡¯ğŸ‡µ</span>
                            <span class="country-name">Japan 2021</span>
                            <span class="country-count">Parallel â€¢ 465 seats â€¢ No threshold â€¢ D'Hondt</span>
                        </button>
                        
                        <!-- Taiwan (newest first) -->
                        <button onclick="importElectionPreset('taiwan_2024')" class="country-btn">
                            <span class="country-flag">ğŸ‡¹ğŸ‡¼</span>
                            <span class="country-name">Taiwan 2024</span>
                            <span class="country-count">Parallel â€¢ 113 seats â€¢ 5% threshold â€¢ D'Hondt</span>
                        </button>
                        <button onclick="importElectionPreset('taiwan_2020')" class="country-btn">
                            <span class="country-flag">ğŸ‡¹ğŸ‡¼</span>
                            <span class="country-name">Taiwan 2020</span>
                            <span class="country-count">Parallel â€¢ 113 seats â€¢ 5% threshold â€¢ D'Hondt</span>
                        </button>
                        
                        <!-- Italy -->
                        <button onclick="importElectionPreset('italy_2022')" class="country-btn">
                            <span class="country-flag">ğŸ‡®ğŸ‡¹</span>
                            <span class="country-name">Italy 2022</span>
                            <span class="country-count">Parallel â€¢ 400 seats â€¢ 3% threshold â€¢ D'Hondt</span>
                        </button>
                        <button onclick="importElectionPreset('italy_2018')" class="country-btn">
                            <span class="country-flag">ğŸ‡®ğŸ‡¹</span>
                            <span class="country-name">Italy 2018</span>
                            <span class="country-count">Parallel â€¢ 630 seats â€¢ 3% threshold â€¢ D'Hondt</span>
                        </button>
                        
                        <!-- New Zealand (newest first) -->
                        <button onclick="importElectionPreset('new_zealand_2023')" class="country-btn">
                            <span class="country-flag">ğŸ‡³ğŸ‡¿</span>
                            <span class="country-name">New Zealand 2023</span>
                            <span class="country-count">MMP â€¢ 120 seats â€¢ 5% threshold â€¢ Sainte-LaguÃ«</span>
                        </button>
                        <button onclick="importElectionPreset('new_zealand_2020')" class="country-btn">
                            <span class="country-flag">ğŸ‡³ğŸ‡¿</span>
                            <span class="country-name">New Zealand 2020</span>
                            <span class="country-count">MMP â€¢ 120 seats â€¢ 5% threshold â€¢ Sainte-LaguÃ«</span>
                        </button>
                        
                        <!-- Netherlands (newest first) -->
                        <button onclick="importElectionPreset('netherlands_2023')" class="country-btn">
                            <span class="country-flag">ğŸ‡³ğŸ‡±</span>
                            <span class="country-name">Netherlands 2023</span>
                            <span class="country-count">Party-List â€¢ 150 seats â€¢ 0.67% threshold â€¢ Hare Quota</span>
                        </button>
                        <button onclick="importElectionPreset('netherlands_2021')" class="country-btn">
                            <span class="country-flag">ğŸ‡³ğŸ‡±</span>
                            <span class="country-name">Netherlands 2021</span>
                            <span class="country-count">Party-List â€¢ 150 seats â€¢ 0.67% threshold â€¢ Hare Quota</span>
                        </button>
                        
                        <!-- Sweden (newest first) -->
                        <button onclick="importElectionPreset('sweden_2022')" class="country-btn">
                            <span class="country-flag">ğŸ‡¸ğŸ‡ª</span>
                            <span class="country-name">Sweden 2022</span>
                            <span class="country-count">Party-List â€¢ 349 seats â€¢ 4% threshold â€¢ Sainte-LaguÃ«</span>
                        </button>
                        <button onclick="importElectionPreset('sweden_2018')" class="country-btn">
                            <span class="country-flag">ğŸ‡¸ğŸ‡ª</span>
                            <span class="country-name">Sweden 2018</span>
                            <span class="country-count">Party-List â€¢ 349 seats â€¢ 4% threshold â€¢ Sainte-LaguÃ«</span>
                        </button>
                        
                        <!-- Single elections (by year, newest first) -->
                        <button onclick="importElectionPreset('alaska_2022')" class="country-btn">
                            <span class="country-flag">ğŸ‡ºğŸ‡¸</span>
                            <span class="country-name">Alaska 2022</span>
                            <span class="country-count">IRV â€¢ U.S. House</span>
                        </button>
                        <button onclick="importElectionPreset('us_house_2012')" class="country-btn">
                            <span class="country-flag">ğŸ‡ºğŸ‡¸</span>
                            <span class="country-name">US House 2012</span>
                            <span class="country-count">FPTP â€¢ 435 seats</span>
                        </button>
                        <button onclick="importElectionPreset('us_house_1952')" class="country-btn">
                            <span class="country-flag">ğŸ‡ºğŸ‡¸</span>
                            <span class="country-name">US House 1952</span>
                            <span class="country-count">FPTP â€¢ 435 seats</span>
                        </button>
                        <button onclick="importElectionPreset('us_house_1942')" class="country-btn">
                            <span class="country-flag">ğŸ‡ºğŸ‡¸</span>
                            <span class="country-name">US House 1942</span>
                            <span class="country-count">FPTP â€¢ 435 seats</span>
                        </button>
                        <button onclick="importElectionPreset('us_house_1916')" class="country-btn">
                            <span class="country-flag">ğŸ‡ºğŸ‡¸</span>
                            <span class="country-name">US House 1916</span>
                            <span class="country-count">FPTP â€¢ 435 seats</span>
                        </button>
                        <button onclick="importElectionPreset('us_house_1888')" class="country-btn">
                            <span class="country-flag">ğŸ‡ºğŸ‡¸</span>
                            <span class="country-name">US House 1888</span>
                            <span class="country-count">FPTP â€¢ 325 seats</span>
                        </button>
                        <button onclick="importElectionPreset('us_house_1848')" class="country-btn">
                            <span class="country-flag">ğŸ‡ºğŸ‡¸</span>
                            <span class="country-name">US House 1848</span>
                            <span class="country-count">FPTP â€¢ 231 seats</span>
                        </button>
                        <button onclick="importElectionPreset('us_house_1842')" class="country-btn">
                            <span class="country-flag">ğŸ‡ºğŸ‡¸</span>
                            <span class="country-name">US House 1842</span>
                            <span class="country-count">FPTP â€¢ 223 seats</span>
                        </button>
                        <button onclick="importElectionPreset('maine_2018_cd2')" class="country-btn">
                            <span class="country-flag">ğŸ‡ºğŸ‡¸</span>
                            <span class="country-name">Maine 2018 CD2</span>
                            <span class="country-count">IRV â€¢ 1 seat</span>
                        </button>
                        <button onclick="importElectionPreset('uk_2024')" class="country-btn">
                            <span class="country-flag">ğŸ‡¬ğŸ‡§</span>
                            <span class="country-name">United Kingdom 2024</span>
                            <span class="country-count">FPTP â€¢ 650 seats</span>
                        </button>
                        <button onclick="importElectionPreset('uk_2019')" class="country-btn">
                            <span class="country-flag">ğŸ‡¬ğŸ‡§</span>
                            <span class="country-name">United Kingdom 2019</span>
                            <span class="country-count">FPTP â€¢ 650 seats</span>
                        </button>
                        <button onclick="importElectionPreset('uk_2017')" class="country-btn">
                            <span class="country-flag">ğŸ‡¬ğŸ‡§</span>
                            <span class="country-name">United Kingdom 2017</span>
                            <span class="country-count">FPTP â€¢ 650 seats</span>
                        </button>
                        <button onclick="importElectionPreset('uk_2015')" class="country-btn">
                            <span class="country-flag">ğŸ‡¬ğŸ‡§</span>
                            <span class="country-name">United Kingdom 2015</span>
                            <span class="country-count">FPTP â€¢ 650 seats</span>
                        </button>
                        <button onclick="importElectionPreset('uk_2010')" class="country-btn">
                            <span class="country-flag">ğŸ‡¬ğŸ‡§</span>
                            <span class="country-name">United Kingdom 2010</span>
                            <span class="country-count">FPTP â€¢ 650 seats</span>
                        </button>
                        <button onclick="importElectionPreset('uk_1974_feb')" class="country-btn">
                            <span class="country-flag">ğŸ‡¬ğŸ‡§</span>
                            <span class="country-name">UK 1974 (Feb)</span>
                            <span class="country-count">FPTP â€¢ 635 seats</span>
                        </button>
                        <button onclick="importElectionPreset('uk_1951')" class="country-btn">
                            <span class="country-flag">ğŸ‡¬ğŸ‡§</span>
                            <span class="country-name">UK 1951</span>
                            <span class="country-count">FPTP â€¢ 625 seats</span>
                        </button>
                        <button onclick="importElectionPreset('canada_2025')" class="country-btn">
                            <span class="country-flag">ğŸ‡¨ğŸ‡¦</span>
                            <span class="country-name">Canada 2025</span>
                            <span class="country-count">FPTP â€¢ 343 seats</span>
                        </button>
                        <button onclick="importElectionPreset('canada_2021')" class="country-btn">
                            <span class="country-flag">ğŸ‡¨ğŸ‡¦</span>
                            <span class="country-name">Canada 2021</span>
                            <span class="country-count">FPTP â€¢ 338 seats</span>
                        </button>
                        <button onclick="importElectionPreset('canada_2019')" class="country-btn">
                            <span class="country-flag">ğŸ‡¨ğŸ‡¦</span>
                            <span class="country-name">Canada 2019</span>
                            <span class="country-count">FPTP â€¢ 338 seats</span>
                        </button>
                        <button onclick="importElectionPreset('canada_2011')" class="country-btn">
                            <span class="country-flag">ğŸ‡¨ğŸ‡¦</span>
                            <span class="country-name">Canada 2011</span>
                            <span class="country-count">FPTP â€¢ 308 seats</span>
                        </button>
                        <button onclick="importElectionPreset('canada_2008')" class="country-btn">
                            <span class="country-flag">ğŸ‡¨ğŸ‡¦</span>
                            <span class="country-name">Canada 2008</span>
                            <span class="country-count">FPTP â€¢ 308 seats</span>
                        </button>
                        <button onclick="importElectionPreset('canada_1979')" class="country-btn">
                            <span class="country-flag">ğŸ‡¨ğŸ‡¦</span>
                            <span class="country-name">Canada 1979</span>
                            <span class="country-count">FPTP â€¢ 282 seats</span>
                        </button>
                        <button onclick="importElectionPreset('israel_2022')" class="country-btn">
                            <span class="country-flag">ğŸ‡®ğŸ‡±</span>
                            <span class="country-name">Israel 2022</span>
                            <span class="country-count">Party-List â€¢ 120 seats â€¢ 3.25% threshold â€¢ D'Hondt</span>
                        </button>
                        <button onclick="importElectionPreset('israel_2021')" class="country-btn">
                            <span class="country-flag">ğŸ‡®ğŸ‡±</span>
                            <span class="country-name">Israel 2021</span>
                            <span class="country-count">Party-List â€¢ 120 seats â€¢ 3.25% threshold â€¢ D'Hondt</span>
                        </button>
                        <button onclick="importElectionPreset('ireland_pres_2011')" class="country-btn">
                            <span class="country-flag">ğŸ‡®ğŸ‡ª</span>
                            <span class="country-name">Ireland 2011</span>
                            <span class="country-count">IRV â€¢ Presidential</span>
                        </button>
                    </div>
                    
                    <div style="margin-top: 15px; padding: 12px; background: #e8f5e9; border-left: 4px solid #4caf50; border-radius: 4px;">
                        <p style="margin: 0; color: #2e7d32; font-weight: 500;">ğŸ’¡ How it works:</p>
                        <p style="margin: 8px 0 0 0; color: #424242; line-height: 1.5;">
1. Click an election to load parties and vote counts<br>
2. Click "Calculate" to see the actual results<br>
3. Change the electoral system dropdown to run counterfactual analysis<br>
4. Edit vote counts if you want to explore scenarios
                        </p>
                    </div>
                </div>
            </section>

            <!-- Electoral System Selection -->
            <section class="card">
                <h2>1. Choose Electoral System</h2>
                <select id="electoralSystem" class="system-select">
                    <option value="">-- Select an Electoral System --</option>
                    <option value="fptp">First-Past-the-Post (FPTP) / Single-Member Plurality (SMP)</option>
                    <option value="irv">Instant-Runoff Voting (IRV) / Ranked-Choice Voting (RCV)</option>
                    <option value="stv">Single Transferable Vote (STV)</option>
                    <option value="mmp">Mixed-Member Proportional (MMP) / Additional Member System (AMS)</option>
                    <option value="parallel">Parallel Voting / Mixed-Member Majoritarian (MMM)</option>
                    <option value="party-list">Party-List Proportional Representation (PR)</option>
                </select>
                <div id="systemDescription" class="system-description"></div>
            </section>

            <!-- Party Management Section -->
            <section class="card" id="partiesSection" style="display: none;">
                <h2><span class="section-number">2</span>. Political Parties</h2>
                
                <!-- Import Countries Feature - Collapsible -->
                <div class="country-import-container">
                    <button onclick="toggleCountryImport()" class="country-toggle-btn">
                        <span id="countryToggleIcon">â–¶</span> ğŸŒ Import Political Parties from Country
                    </button>
                    
                    <div id="countryImportPanel" class="country-import-panel" style="display: none;">
                        <p style="margin-bottom: 15px; color: #666;">Select a country to import its major political parties with authentic names and colors:</p>
                        <div class="country-grid">
                            <button onclick="importCountryParties('USA')" class="country-btn">
                                <span class="country-flag">ğŸ‡ºğŸ‡¸</span>
                                <span class="country-name">USA</span>
                                <span class="country-count">4 parties</span>
                            </button>
                            <button onclick="importCountryParties('Canada')" class="country-btn">
                                <span class="country-flag">ğŸ‡¨ğŸ‡¦</span>
                                <span class="country-name">Canada</span>
                                <span class="country-count">5 parties</span>
                            </button>
                            <button onclick="importCountryParties('Taiwan')" class="country-btn">
                                <span class="country-flag">ğŸ‡¹ğŸ‡¼</span>
                                <span class="country-name">Taiwan</span>
                                <span class="country-count">4 parties</span>
                            </button>
                            <button onclick="importCountryParties('France')" class="country-btn">
                                <span class="country-flag">ğŸ‡«ğŸ‡·</span>
                                <span class="country-name">France</span>
                                <span class="country-count">6 parties</span>
                            </button>
                            <button onclick="importCountryParties('Germany')" class="country-btn">
                                <span class="country-flag">ğŸ‡©ğŸ‡ª</span>
                                <span class="country-name">Germany</span>
                                <span class="country-count">6 parties</span>
                            </button>
                            <button onclick="importCountryParties('Chile')" class="country-btn">
                                <span class="country-flag">ğŸ‡¨ğŸ‡±</span>
                                <span class="country-name">Chile</span>
                                <span class="country-count">6 parties</span>
                            </button>
                            <button onclick="importCountryParties('Spain')" class="country-btn">
                                <span class="country-flag">ğŸ‡ªğŸ‡¸</span>
                                <span class="country-name">Spain</span>
                                <span class="country-count">5 parties</span>
                            </button>
                            <button onclick="importCountryParties('Italy')" class="country-btn">
                                <span class="country-flag">ğŸ‡®ğŸ‡¹</span>
                                <span class="country-name">Italy</span>
                                <span class="country-count">6 parties</span>
                            </button>
                            <button onclick="importCountryParties('Finland')" class="country-btn">
                                <span class="country-flag">ğŸ‡«ğŸ‡®</span>
                                <span class="country-name">Finland</span>
                                <span class="country-count">8 parties</span>
                            </button>
                            <button onclick="importCountryParties('Austria')" class="country-btn">
                                <span class="country-flag">ğŸ‡¦ğŸ‡¹</span>
                                <span class="country-name">Austria</span>
                                <span class="country-count">5 parties</span>
                            </button>
                            <button onclick="importCountryParties('Portugal')" class="country-btn">
                                <span class="country-flag">ğŸ‡µğŸ‡¹</span>
                                <span class="country-name">Portugal</span>
                                <span class="country-count">5 parties</span>
                            </button>
                            <button onclick="importCountryParties('Poland')" class="country-btn">
                                <span class="country-flag">ğŸ‡µğŸ‡±</span>
                                <span class="country-name">Poland</span>
                                <span class="country-count">6 parties</span>
                            </button>
                            <button onclick="importCountryParties('Ireland')" class="country-btn">
                                <span class="country-flag">ğŸ‡®ğŸ‡ª</span>
                                <span class="country-name">Ireland</span>
                                <span class="country-count">5 parties</span>
                            </button>
                            <button onclick="importCountryParties('Estonia')" class="country-btn">
                                <span class="country-flag">ğŸ‡ªğŸ‡ª</span>
                                <span class="country-name">Estonia</span>
                                <span class="country-count">5 parties</span>
                            </button>
                            <button onclick="importCountryParties('Latvia')" class="country-btn">
                                <span class="country-flag">ğŸ‡±ğŸ‡»</span>
                                <span class="country-name">Latvia</span>
                                <span class="country-count">6 parties</span>
                            </button>
                            <button onclick="importCountryParties('Lithuania')" class="country-btn">
                                <span class="country-flag">ğŸ‡±ğŸ‡¹</span>
                                <span class="country-name">Lithuania</span>
                                <span class="country-count">6 parties</span>
                            </button>
                            <button onclick="importCountryParties('Sweden')" class="country-btn">
                                <span class="country-flag">ğŸ‡¸ğŸ‡ª</span>
                                <span class="country-name">Sweden</span>
                                <span class="country-count">8 parties</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="input-group">
                    <input type="text" id="partyName" placeholder="Party name (e.g., Progressive Party)">
                    <div class="color-picker-wrapper">
                        <div class="color-presets" id="colorPresets">
                            <button type="button" class="color-preset" data-color="#e74c3c" style="background: #e74c3c;" title="Red"></button>
                            <button type="button" class="color-preset" data-color="#3498db" style="background: #3498db;" title="Blue"></button>
                            <button type="button" class="color-preset" data-color="#2ecc71" style="background: #2ecc71;" title="Green"></button>
                            <button type="button" class="color-preset" data-color="#f39c12" style="background: #f39c12;" title="Orange"></button>
                            <button type="button" class="color-preset" data-color="#9b59b6" style="background: #9b59b6;" title="Purple"></button>
                            <button type="button" class="color-preset" data-color="#1abc9c" style="background: #1abc9c;" title="Teal"></button>
                            <button type="button" class="color-preset" data-color="#e91e63" style="background: #e91e63;" title="Pink"></button>
                            <button type="button" class="color-preset" data-color="#34495e" style="background: #34495e;" title="Dark Gray"></button>
                            <button type="button" class="color-preset" data-color="#f1c40f" style="background: #f1c40f;" title="Yellow"></button>
                            <button type="button" class="color-preset custom-color" onclick="document.getElementById('partyColorPicker').click();" title="Custom Color">
                                <span style="font-size: 16px;">+</span>
                            </button>
                        </div>
                        <input type="color" id="partyColorPicker" style="display: none;" value="#3498db">
                        <input type="hidden" id="partyColor" value="#3498db">
                    </div>
                    <button onclick="addParty()" class="btn-primary">Add Party</button>
                </div>
                <div id="partiesList" class="items-list"></div>
            </section>

            <!-- Candidate Management Section -->
            <section class="card" id="candidatesSection" style="display: none;">
                <h2><span class="section-number">3</span>. Candidates</h2>
                <div class="input-group">
                    <input type="text" id="candidateName" placeholder="Candidate name">
                    <select id="candidateParty">
                        <option value="">Select Party</option>
                    </select>
                    <button onclick="addCandidate()" class="btn-primary">Add Candidate</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <button onclick="autoGenerateCandidates()" class="btn-secondary">
                        âš¡ Auto-Generate One Candidate per Party
                    </button>
                </div>
                <div id="candidatesList" class="items-list"></div>
            </section>

            <!-- Voting Input Section -->
            <section class="card" id="votingSection" style="display: none;">
                <h2><span class="section-number">4</span>. Voting Results</h2>
                
                <!-- Autofill Button -->
                <div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ffc107;">
                    <h4 style="margin: 0 0 10px 0; color: #856404;">âš¡ Quick Fill</h4>
                    <button onclick="autofillVotes()" class="btn-secondary" style="background: linear-gradient(135deg, #ffc107 0%, #ff9800 100%);">
                        ğŸ² Auto-Fill Random Votes
                    </button>
                    <p style="margin: 10px 0 0 0; font-size: 0.9em; color: #856404;">Automatically generates realistic vote totals for all candidates/parties</p>
                </div>
                
                
                <!-- Race Type Selection -->
                <div class="race-type-selector">
                    <label style="display: block; margin-bottom: 10px; font-weight: 600; color: #667eea;">
                        Election Scope:
                    </label>
                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                        <label class="radio-option" id="singleRaceOption">
                            <input type="radio" name="raceType" id="singleRaceRadio" value="single" checked onchange="updateRaceType()">
                            <span>ğŸ Single Race (1 seat or district)</span>
                        </label>
                        <label class="radio-option" id="legislativeRaceOption">
                            <input type="radio" name="raceType" id="legislativeRaceRadio" value="legislative" onchange="updateRaceType()">
                            <span>ğŸ›ï¸ Entire Legislature</span>
                        </label>
                        
                        <div id="legislatureSeatsContainer" style="display: none; align-items: center; gap: 15px; margin-left: 20px; flex-wrap: wrap; width: 100%;">
                            <!-- Single seats input for party-list, IRV, STV, FPTP -->
                            <div id="singleSeatsInput" style="display: flex; align-items: center; gap: 10px;">
                                <label for="totalLegislatureSeats" style="font-weight: 600; color: #667eea;">Seats:</label>
                                <input type="number" id="totalLegislatureSeats" value="100" min="2" max="1000" 
                                       style="width: 80px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
                            </div>
                            
                            <!-- Discrete tier inputs for MMP/MMM -->
                            <div id="discreteTierSeatsInputs" style="display: none; flex-wrap: wrap; gap: 15px;">
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label for="districtSeatsInput" style="font-weight: 600; color: #667eea;">District Seats:</label>
                                    <input type="number" id="districtSeatsInput" value="299" min="0" max="1000" 
                                           style="width: 80px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label for="listSeatsInput" style="font-weight: 600; color: #667eea;">List Seats (Base):</label>
                                    <input type="number" id="listSeatsInput" value="299" min="0" max="1000" 
                                           style="width: 80px; padding: 8px; border: 2px solid #e0e0e0; border-radius: 8px;">
                                </div>
                                <div id="calculatedTotalSeats" style="margin-left: 10px; padding: 8px 12px; background: #f0f4ff; border-radius: 6px; font-weight: 600; color: #667eea;">
                                    Base Total: <span id="totalSeatsDisplay">598</span>
                                    <span style="font-size: 0.85em; color: #888; margin-left: 5px;">(+overhang if MMP)</span>
                                </div>
                            </div>
                            
                            <select id="parliamentPresets" onchange="applyParliamentPreset()" 
                                    style="padding: 8px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px; min-width: 180px;">
                                <option value="">-- Real-World Presets --</option>
                                <option value="349">ğŸ‡¸ğŸ‡ª Sweden (349)</option>
                                <option value="598">ğŸ‡©ğŸ‡ª Germany (598)</option>
                                <option value="435">ğŸ‡ºğŸ‡¸ US House (435)</option>
                                <option value="650">ğŸ‡¬ğŸ‡§ UK Commons (650)</option>
                                <option value="465">ğŸ‡¯ğŸ‡µ Japan (465)</option>
                                <option value="120">ğŸ‡³ğŸ‡¿ New Zealand (120)</option>
                                <option value="160">ğŸ‡®ğŸ‡ª Ireland DÃ¡il (160)</option>
                            </select>
                            
                            <!-- MMP/MMM discrete tier presets -->
                            <select id="parliamentPresetsMixed" onchange="applyParliamentPreset()" 
                                    style="display: none; padding: 8px; border-radius: 8px; border: 2px solid #e0e0e0; font-size: 14px; min-width: 180px;">
                                <option value="">-- Mixed System Presets --</option>
                                <option value="germany">ğŸ‡©ğŸ‡ª Germany (299+299)</option>
                                <option value="japan">ğŸ‡¯ğŸ‡µ Japan (289+176)</option>
                                <option value="new_zealand">ğŸ‡³ğŸ‡¿ New Zealand (72+48)</option>
                                <option value="taiwan">ğŸ‡¹ğŸ‡¼ Taiwan (79+34)</option>
                            </select>
                        </div>
                    </div>
                    <p id="raceTypeDescription" style="color: #666; font-size: 0.9em; font-style: italic; margin-bottom: 20px;">
                        Single race: Simulate one electoral district or seat (e.g., one House district).
                    </p>
                </div>
                
                <div id="electoralThresholdContainer" style="display: none; margin-bottom: 20px;">
                    <label for="electoralThreshold" style="display: block; margin-bottom: 8px; font-weight: 600; color: #667eea;">
                        Electoral Threshold (%)
                    </label>
                    <input type="number" id="electoralThreshold" min="0" max="100" step="0.1" value="5" 
                           style="width: 150px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <p style="margin-top: 8px; color: #666; font-size: 0.9em; font-style: italic;">
                        Minimum vote share (%) a party needs to win seats. Common values: 3%, 4%, or 5%
                    </p>
                    <p style="margin-top: 8px; color: #495057; font-size: 0.9em; line-height: 1.6;">
                        <strong>Real-World Thresholds:</strong><br>
                        <strong>0.25% - 2%:</strong> Netherlands, Denmark, South Africa<br>
                        <strong>3% - 5%:</strong> Germany, Sweden, New Zealand, Greece, Czechia, Norway, Austria<br>
                        <strong>7% - 10%:</strong> Turkey, Russia, Liechtenstein
                    </p>
                </div>
                
                <div id="thresholdBypassContainer" style="display: none; margin-bottom: 20px;">
                    <label for="bypassThresholdInput" style="display: block; margin-bottom: 8px; font-weight: 600; color: #667eea;">
                        Bypass Threshold (Minimum electorate seats to bypass threshold)
                    </label>
                    <input type="number" id="bypassThresholdInput" min="0" max="10" step="1" value="1" 
                           style="width: 150px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                    <p style="margin-top: 5px; font-size: 0.9em; color: #666;">
                        New Zealand: 1 seat | Germany: 3 seats
                    </p>
                </div>
                
                <div id="allocationMethodContainer" style="display: none; margin-bottom: 20px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 600; color: #667eea;">
                        Seat Allocation Method
                    </label>
                    <select id="allocationMethod" style="width: 250px; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px;">
                        <option value="dhondt">D'Hondt (favors larger parties)</option>
                        <option value="sainte-lague">Sainte-LaguÃ« (more proportional)</option>
                        <option value="hare">Hare Quota (most proportional)</option>
                    </select>
                    <p style="margin-top: 8px; color: #666; font-size: 0.9em; font-style: italic;">
                        D'Hondt tends to give bonus seats to larger parties; Sainte-LaguÃ« is more proportional to small parties; Hare Quota is the most proportional method.
                    </p>
                </div>
                
                <div id="overhangCompensationContainer" style="display: none; margin-top: 15px; margin-bottom: 20px;">
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-bottom: 15px;">
                        <input type="checkbox" id="enableOverhangToggle" style="width: 18px; height: 18px;" checked>
                        <span style="font-weight: 600; color: #667eea;">Enable Overhang Seats (NZ Style)</span>
                    </label>
                    <p style="margin-top: 5px; font-size: 0.9em; color: #666; margin-left: 28px;">
                        When enabled, parties keep electorate seats that exceed their proportional entitlement, increasing total house size.
                    </p>
                    
                    <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; margin-top: 15px; margin-left: 28px;" id="fullCompensationLabel">
                        <input type="checkbox" id="enableFullCompensationToggle" style="width: 18px; height: 18px;">
                        <span style="font-weight: 600; color: #667eea;">Enable Full Compensation (German Style)</span>
                    </label>
                    <p style="margin-top: 5px; font-size: 0.9em; color: #666; margin-left: 56px;">
                        When enabled, extra seats are granted to all other parties until original proportionality is restored (Leveling Seats).
                    </p>
                </div>
                
                <div id="votingInputs"></div>
                
                <!-- Ranking Ballots Section (for IRV, STV, Borda, Condorcet) -->
                <div id="rankingBallotsSection" style="display: none; margin-top: 25px;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ“Š Ranking Ballots</h3>
                    <p style="color: #666; margin-bottom: 15px;">
                        Define different ballot types showing voter preferences. Each ballot type represents a group of voters with the same ranking preferences.
                    </p>
                    
                    <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 6px;">
                        <label for="numBallotTypes" style="font-weight: 600; margin-right: 10px;">
                            Number of Ballot Types:
                        </label>
                        <div style="display: flex; align-items: center; gap: 5px;">
                            <button type="button" onclick="decrementBallotTypes()" style="
                                width: 30px; 
                                height: 30px; 
                                padding: 0; 
                                border: 1px solid #ddd; 
                                border-radius: 4px; 
                                background: #f5f5f5; 
                                cursor: pointer;
                                font-size: 16px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">âˆ’</button>
                            <input 
                                type="number" 
                                id="numBallotTypes" 
                                min="1" 
                                max="20" 
                                value="3" 
                                readonly
                                style="width: 80px; padding: 6px; border: 1px solid #ddd; border-radius: 4px; text-align: center;"
                            >
                            <button type="button" onclick="incrementBallotTypes()" style="
                                width: 30px; 
                                height: 30px; 
                                padding: 0; 
                                border: 1px solid #ddd; 
                                border-radius: 4px; 
                                background: #f5f5f5; 
                                cursor: pointer;
                                font-size: 16px;
                                display: flex;
                                align-items: center;
                                justify-content: center;
                            ">+</button>
                        </div>
                        <span style="margin-left: 10px; color: #666; font-size: 0.9em;">
                            (Max: 20 different ballot patterns)
                        </span>
                    </div>
                    
                    <div id="rankingBallotsContainer"></div>
                </div>
                
                <!-- Manual Seat Override Toggle (MMP/MMM only) -->
                <div id="manualSeatOverrideSection" style="display: none; margin-top: 20px; padding: 20px; background: #f8f9fa; border: 2px solid #667eea; border-radius: 12px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 5px 0; color: #667eea;">Manual Seat Input</h4>
                            <p style="margin: 0; font-size: 0.9em; color: #666;">Override automatic seat allocation with actual results</p>
                        </div>
                        <label class="toggle-switch" style="position: relative; display: inline-block; width: 60px; height: 34px;">
                            <input type="checkbox" id="manualSeatOverrideToggle" style="opacity: 0; width: 0; height: 0;">
                            <span class="toggle-slider" style="position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px;"></span>
                        </label>
                    </div>
                    
                    <!-- Seat Input Grid (initially hidden) -->
                    <div id="manualSeatInputs" style="display: none;">
                        <div style="margin-bottom: 15px; padding: 10px; background: #e3f2fd; border-left: 4px solid #2196f3; border-radius: 4px;">
                            <strong style="color: #1565c0;">Manual Entry Mode Active</strong>
                            <p style="margin: 5px 0 0 0; font-size: 0.9em; color: #1976d2;">
                                Enter the actual seats won by each party. The system will compare these to calculated values.
                            </p>
                        </div>
                        
                        <!-- Dynamic seat inputs will be generated here -->
                        <div id="manualSeatInputGrid" class="voting-input-section">
                            <!-- Generated by updateManualSeatInputs() -->
                        </div>
                        
                        <!-- Total Seats Counter with Real-time Validation -->
                        <div id="manualSeatsTotalContainer" style="margin-top: 15px; padding: 15px; background: white; border-radius: 8px; border: 2px solid #e0e0e0;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <strong style="font-size: 1.1em;">Total Seats Entered:</strong>
                                    <span id="manualSeatsTotal" style="font-size: 1.2em; font-weight: 600; color: #667eea; margin-left: 10px;">0</span>
                                </div>
                                <div>
                                    <strong style="font-size: 1.1em;">Expected Total:</strong>
                                    <span id="expectedSeatsTotal" style="font-size: 1.2em; font-weight: 600; color: #666; margin-left: 10px;">0</span>
                                </div>
                            </div>
                            <div id="seatValidationIndicator" style="margin-top: 10px; padding: 10px; border-radius: 4px; display: none;">
                                <!-- Status message populated by validateManualSeats() -->
                            </div>
                        </div>
                        
                    </div>
                </div>
                
                <button onclick="calculateResults()" class="btn-calculate">ğŸ—³ï¸ Calculate Election Results</button>
            </section>

            <!-- Results Section -->
            <section class="card results-section" id="resultsSection" style="display: none;">
                <h2>ğŸ“Š Election Results</h2>
                <div id="results"></div>
                
                <h3>âš–ï¸ Arrow's Impossibility Theorem Analysis</h3>
                <div id="arrowAnalysis" class="arrow-analysis"></div>
            </section>


            <!-- AI Analysis Section -->
            <section class="card ai-analysis-section" id="aiAnalysisSection" style="display: none;">
                <h2>ğŸ¤– AI Expert Analysis</h2>
                <p>Get expert political science analysis of your election results using Mistral AI.</p>
                
                <button id="aiAnalysisBtn" class="btn-calculate" onclick="getAIAnalysisMain()" style="margin-top: 20px;">
                    <span>ğŸ”</span> Get AI Analysis of This Election
                </button>
                
                <div id="aiResponseMain" class="ai-response-main"></div>
            </section>
        </div>
    </div>

    <!-- Chart.js for improved visualizations -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // Verify Chart.js loaded
        window.addEventListener('DOMContentLoaded', function() {
            if (typeof Chart === 'undefined') {
                console.error('âŒ Chart.js failed to load from CDN');
                alert('Chart library failed to load. Charts may not display correctly.');
            } else {
                console.log('âœ… Chart.js loaded successfully', Chart.version);
            }
        });
    </script>
    <script src="chartjs-wrapper.js"></script>
    <script src="tie-breaking.js"></script>
    <script src="round-by-round.js"></script>
    <script src="calculations.js"></script>
    <script src="state-manager.js"></script>
    <script src="api-client.js"></script>
    <script src="borda-condorcet.js"></script>
    <script src="enhanced-viz.js"></script>
    <script src="advanced-features.js"></script>
    <script src="ai-analysis-main.js"></script>
    <script src="country-import.js"></script>
    <script src="presets.js"></script>
    <script src="app.js"></script>
    
    <!-- AI Analysis Section (moved from learn-more.html) -->
    <div class="card" style="margin: 40px auto; max-width: 800px;">
        <h2>ğŸ¤– Ask AI for Election Analysis</h2>
        <p>Get expert analysis of your simulated election results using Mistral AI. The AI will analyze the systemic flaws, relevant voting principles, and suggest improvements.</p>
        
        <div class="warning-box" style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 20px 0; border-radius: 4px;">
            <strong>âš ï¸ Note:</strong> This feature requires a Mistral AI API key. You'll need to add your API key to the code to use this feature.
        </div>
        
        <button id="aiAnalysisBtnLearn" class="btn-calculate" onclick="getAIAnalysisLearn()" style="margin-top: 20px;">
            <span>ğŸ”</span> Get AI Analysis of Last Election
        </button>
        
        <div id="aiResponseLearn" class="ai-response" style="margin-top: 20px; padding: 20px; background: #f8f9fa; border-radius: 8px; display: none;"></div>
    </div>
    
    <!-- Share and Reset Simulator Buttons -->
    <div style="text-align: center; margin: 40px 0 20px 0; display: flex; gap: 15px; justify-content: center;">
        <button onclick="shareScenario()" 
                style="padding: 12px 24px; background: #667eea; color: white; border: none; 
                       border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;
                       box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s;">
            ğŸ”— Share Scenario
        </button>
        <button onclick="resetSimulator()" 
                style="padding: 12px 24px; background: #dc3545; color: white; border: none; 
                       border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;
                       box-shadow: 0 2px 4px rgba(0,0,0,0.2); transition: background 0.2s;">
            ğŸ”„ Reset Simulator
        </button>
    </div>
</body>
</html>

